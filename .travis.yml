language: python
python:
- '3.7'
install:
- pip install -r requirements.txt
env:
  global:
  - DJANGO_SETTINGS_MODULE="coronawatch.settings"
  - HEROKU_API_KEY="1e9ad3f4-8875-4f62-bae8-424b643ce1c0"
  - HEROKU_APP_APP="coronawatch"

services:
- postgresql
- docker
before_install:
- psql -c 'create database coronawatch;' -U postgres
- docker-compose build
script:
- echo "Starting tests"
- python manage.py test
#- docker-compose run web sh -c "python manage.py test"
# deploy:
#   provider: script
#   script:
#     docker login --username=_ --password=$HEROKU_API_KEY registry.heroku.com;
#     heroku container:push web --app coronawatch;
#     heroku container:release web --app coronawatch
#   on:
#      branch: master
deploy:
  provider: heroku
  api_key:
    secure: "rouIZs7L5jYnUiQSTJdpoLzZSup9KhW5I2Q27pqZbYN8LJ9NZWZaB9OE9KA1DYq5cGS3wQDdAnhd7kZtYFFnSA7PFpmvo9O8I0HuNFet85hYhRo8NXIOyJrgyD1KZCD4mQQ6ujBjAUTnIzDh+uhuYgRZy7aQQryfoq79jwe1XGBSSH4Nih5A5ORGI4vQPGn7B3X3UQSK14x6Mz7Q0caQO8xQjXE/jVAZUg2TR4D7BPMyd5NXktH8MarWB1Xb2VC1ELCyHy3aM2SdCgELqRpOFhvS+ygnrYxeYTXE2fcQQPUpM5gaYd62WFlM9axEq94naiJrQGTEHpMQkE955tQlSGAkkInVfQ13onqYpuJ1dAyC6tvF+F+P9eE9qf4tiSNx6KTJiTh8d7jCb5oa04c7m1JlmZH0ET8xUuPfaenRxsV/qOgLVWrNKqBgvl3r/6xQkthxaTdApTO7J65ZPKvITtRnzM9FjZhNzpXKjZ5mHs47p9YkhiXI/j4zH/4wZNk23t5Or5q1yBEhA8TUBC6KAsfnOAIifx9afAZIXO0vxxek5WK2vjAtVgbJad/KzfZaOfPgyq1z+eMLg/gE+p+8UOyaYsV6ZLC/IvezFMLVjJFST60WyPaEub/Jly7qQId/LBiBL8WITbxeOyC9EX4ru5fgijUSIEBSfqN/xIp/clc="
  app:
    master: coronawatch
   run:
     - "python manage.py migrate"